<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu - Sistem Informasi RT</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/feather-icons"></script>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <h1>SI Pelayanan RT</h1>
            </div>
            <button class="burger-menu" id="burgerMenu" aria-label="Toggle menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="nav-menu" id="navMenu">
                <a href="/home" class="nav-link">Beranda</a>
                <a href="/dashboard" class="nav-link active">Menu</a>
                <a href="/profil" class="nav-link">Profil</a>
                <a href="/admin" class="nav-link" id="adminLink" style="display: none;">Admin</a>
                <button id="logoutBtn" class="btn btn-secondary btn-small">Logout</button>
            </div>
        </div>
    </nav>

    <main class="dashboard-container">
        <div class="container">
            <div class="dashboard-header">
                <h2>Menu Layanan</h2>
                <p>Pilih layanan yang Anda butuhkan</p>
            </div>

            <section class="menu-section">
                <div class="service-grid">
                    <div class="service-card">
                        <div class="service-icon icon-blue">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H7a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V8z"/>
                                <path d="M14 2v6h6"/>
                                <path d="M9 13h6"/>
                                <path d="M9 17h6"/>
                            </svg>
                        </div>
                        <h4>Pengajuan Surat</h4>
                        <p>Ajukan berbagai jenis surat keterangan yang diperlukan.</p>
                        <a href="/pengajuan-surat" class="btn btn-primary">Pilih</a>
                    </div>
                    <div class="service-card">
                        <div class="service-icon icon-indigo">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="5" width="18" height="14" rx="2" ry="2"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                                <line x1="7" y1="16" x2="9" y2="16"/>
                                <line x1="11" y1="16" x2="13" y2="16"/>
                            </svg>
                        </div>
                        <h4>Pembayaran Iuran Kas RT</h4>
                        <p>Lakukan pembayaran iuran kas RT secara tunai atau transfer.</p>
                        <a href="/pembayaran-iuran" class="btn btn-primary">Pilih</a>
                    </div>
                </div>
            </section>

            <section class="history-section">
                <h3>Riwayat</h3>
                <div class="tabs">
                    <button class="tab-btn active" data-tab="applications">Pengajuan Surat</button>
                    <button class="tab-btn" data-tab="payments">Pembayaran</button>
                </div>
                
                <div id="applicationsTab" class="tab-content active">
                    <div id="applicationsList" class="history-list">
                        <div class="loading">Memuat data...</div>
                    </div>
                </div>
                
                <div id="paymentsTab" class="tab-content">
                    <div id="paymentsList" class="history-list">
                        <div class="loading">Memuat data...</div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script src="script.js"></script>
    <script>
        let currentUser = null;

        // Check authentication
        async function init() {
            try {
                const response = await fetch('/api/user');
                const data = await response.json();
                if (data.user) {
                    currentUser = data.user;
                    if (data.user.role === 'admin') {
                        document.getElementById('adminLink').style.display = 'inline-block';
                    }
                    loadApplications();
                    loadPayments();
                } else {
                    window.location.href = '/login';
                }
            } catch (error) {
                window.location.href = '/login';
            }
        }

        // Load applications
        async function loadApplications() {
            try {
                const response = await fetch('/api/letter-applications/my');
                const data = await response.json();
                const list = document.getElementById('applicationsList');
                
                if (data.applications && data.applications.length > 0) {
                    list.innerHTML = data.applications.map(app => {
                        const summary = window.formatLetterDetailSummary ? formatLetterDetailSummary(app.letter_type, app.details) : '';
                        return `
                        <div class="history-item">
                            <div class="history-header">
                                <span class="history-title">${window.getLetterTypeName ? getLetterTypeName(app.letter_type) : app.letter_type}</span>
                                <span class="status-badge status-${app.status}">${getStatusName(app.status)}</span>
                            </div>
                            <div class="history-info">
                                <span>ID: ${app.application_id}</span>
                                <span>${formatDate(app.created_at)}</span>
                            </div>
                            ${summary ? `<div class="history-summary">${summary}</div>` : ''}
                            ${app.status === 'approved' && app.pdf_path ? 
                                `<a href="/api/letter-applications/${app.id}/download" class="btn btn-small btn-primary">Download Surat</a>` : ''}
                        </div>
                        `;
                    }).join('');
                } else {
                    list.innerHTML = '<div class="empty-message">Belum ada pengajuan surat</div>';
                }
            } catch (error) {
                document.getElementById('applicationsList').innerHTML = '<div class="error-message">Gagal memuat data</div>';
            }
        }

        // Load payments
        async function loadPayments() {
            try {
                const response = await fetch('/api/payments/my');
                const data = await response.json();
                const list = document.getElementById('paymentsList');
                
                if (data.payments && data.payments.length > 0) {
                    list.innerHTML = data.payments.map(payment => `
                        <div class="history-item">
                            <div class="history-header">
                                <span class="history-title">Pembayaran Iuran - ${payment.period}</span>
                                <span class="status-badge status-${payment.status}">${getStatusName(payment.status)}</span>
                            </div>
                            <div class="history-info">
                                <span>Rp ${formatCurrency(payment.amount)}</span>
                                <span>${payment.payment_method}</span>
                                <span>${formatDate(payment.created_at)}</span>
                            </div>
                            ${payment.invoice_path ? 
                                `<a href="/api/payments/${payment.id}/invoice" class="btn btn-small btn-primary">Download Invoice</a>` : ''}
                        </div>
                    `).join('');
                } else {
                    list.innerHTML = '<div class="empty-message">Belum ada pembayaran</div>';
                }
            } catch (error) {
                document.getElementById('paymentsList').innerHTML = '<div class="error-message">Gagal memuat data</div>';
            }
        }

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab + 'Tab').classList.add('active');
            });
        });


        function getStatusName(status) {
            const statuses = {
                'pending': 'Menunggu',
                'approved': 'Disetujui',
                'rejected': 'Ditolak'
            };
            return statuses[status] || status;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID').format(amount);
        }

        // Logout handler
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                if (data.success) {
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Logout error:', error);
            }
        });

        init();
    </script>
</body>
</html>

